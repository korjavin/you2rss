<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YT-Podcaster</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10" integrity="sha384-D1Kt99CQMDuVetoL1lrYwg5t+9QdHe7NLX/SoJYkXDFfX37iInKRy5xLSi8nO7UC" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
</head>
<body>
<main class="container">
    <h1>YT-Podcaster</h1>
    <p>Welcome to YT-Podcaster. Your personal podcast feed for YouTube channels.</p>

    <h2>Add Subscription</h2>
    <div id="debug-info" style="background: #f0f0f0; padding: 10px; margin: 10px 0; font-family: monospace; font-size: 12px;">
        Debug info will appear here...
    </div>
    <form id="subscription-form">
        <label for="url">YouTube Channel URL</label>
        <input type="url" id="url" name="url" placeholder="https://www.youtube.com/channel/..." required>
        <button type="submit">Subscribe</button>
    </form>

    <h2>Your Subscriptions</h2>
    <div id="subscription-list">
        <p>Loading subscriptions...</p>
    </div>
</main>

<script>
// Debug logging function
function debugLog(message) {
    const debugDiv = document.getElementById('debug-info');
    const timestamp = new Date().toLocaleTimeString();
    debugDiv.innerHTML += `<div>${timestamp}: ${message}</div>`;
    debugDiv.scrollTop = debugDiv.scrollHeight;
}

// Debug form state
function debugFormState() {
    debugLog('Subscribe button clicked');
    const form = document.querySelector('form[hx-post]');
    const urlInput = document.getElementById('url');
    
    debugLog('Form valid: ' + form.checkValidity());
    debugLog('URL value: "' + urlInput.value + '"');
    debugLog('URL valid: ' + urlInput.checkValidity());
    debugLog('URL validation message: "' + urlInput.validationMessage + '"');
}

// Initialize Telegram Web App
debugLog('Initializing Telegram Web App...');
window.Telegram.WebApp.ready();

// Debug Telegram Web App state
debugLog('Telegram WebApp available: ' + !!window.Telegram?.WebApp);
debugLog('InitData available: ' + !!window.Telegram?.WebApp?.initData);
debugLog('InitData length: ' + (window.Telegram?.WebApp?.initData?.length || 0));

// Vanilla JS functions
function makeAuthenticatedRequest(method, url, data = null) {
    debugLog('Making ' + method + ' request to ' + url);
    
    if (!window.Telegram || !window.Telegram.WebApp || !window.Telegram.WebApp.initData) {
        debugLog('ERROR: Telegram initData not available!');
        return Promise.reject('No auth data');
    }
    
    const headers = {
        'Authorization': 'tma ' + window.Telegram.WebApp.initData
    };
    
    if (data instanceof FormData) {
        // Convert FormData to URL-encoded string for Go server compatibility
        data = new URLSearchParams(data).toString();
        headers['Content-Type'] = 'application/x-www-form-urlencoded';
    } else if (data) {
        headers['Content-Type'] = 'application/x-www-form-urlencoded';
    }
    
    debugLog('Auth header length: ' + window.Telegram.WebApp.initData.length);
    
    return fetch(url, {
        method: method,
        headers: headers,
        body: data
    }).then(response => {
        debugLog('Response: ' + response.status + ' ' + response.statusText);
        return response;
    });
}

function loadSubscriptions() {
    debugLog('Loading subscriptions...');
    makeAuthenticatedRequest('GET', '/subscriptions')
        .then(response => response.text())
        .then(html => {
            document.getElementById('subscription-list').innerHTML = html;
            debugLog('Subscriptions loaded successfully');
        })
        .catch(error => {
            debugLog('Error loading subscriptions: ' + error);
            document.getElementById('subscription-list').innerHTML = '<p>Error loading subscriptions</p>';
        });
}

function handleSubscriptionSubmit(event) {
    event.preventDefault();
    debugLog('Form submit intercepted by vanilla JS');
    
    const form = document.getElementById('subscription-form');
    const formData = new FormData(form);
    const urlValue = formData.get('url');
    
    debugLog('Submitting URL: ' + urlValue);
    
    if (!form.checkValidity()) {
        debugLog('Form validation failed');
        return;
    }
    
    makeAuthenticatedRequest('POST', '/subscriptions', formData)
        .then(response => {
            if (response.ok) {
                debugLog('Subscription created successfully');
                form.reset();
                loadSubscriptions(); // Reload the subscription list
            } else {
                return response.text().then(text => {
                    debugLog('Subscription failed: ' + response.status + ' - ' + text);
                    alert('Subscription failed: ' + text);
                });
            }
        })
        .catch(error => {
            debugLog('Subscription error: ' + error);
            alert('Subscription failed: ' + error);
        });
}

// Set up theme
if (window.Telegram?.WebApp?.colorScheme === 'dark') {
    document.documentElement.setAttribute('data-theme', 'dark');
}

// Expand the web app to full height
if (window.Telegram?.WebApp?.expand) {
    window.Telegram.WebApp.expand();
}

// Initialize vanilla JS handlers
setTimeout(() => {
    debugLog('Setting up vanilla JS handlers...');
    
    // Load subscriptions on page load
    loadSubscriptions();
    
    // Set up form submit handler
    const form = document.getElementById('subscription-form');
    if (form) {
        form.addEventListener('submit', handleSubscriptionSubmit);
        debugLog('Form submit handler attached');
    } else {
        debugLog('ERROR: Could not find subscription form');
    }
    
    debugLog('Vanilla JS setup complete');
}, 1000);
</script>
</body>
</html>
